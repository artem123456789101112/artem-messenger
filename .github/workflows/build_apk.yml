name: Build APK
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip python3-dev
        sudo apt install -y openjdk-17-jdk
        sudo apt install -y git wget unzip
        sudo apt install -y autoconf automake libtool pkg-config
        sudo apt install -y autoconf-archive  # Важно!
        sudo apt install -y zlib1g-dev libncurses5-dev libffi-dev
        sudo apt install -y libssl-dev
        
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install buildozer
        python3 -m pip install cython==0.29.36
        python3 -m pip install flet==0.21.2
        
        echo "=== Проверка зависимостей ==="
        python3 -c "import Cython; print('✅ Cython установлен')"
        python3 -c "import flet; print('✅ Flet установлен')"
        
    - name: Apply libffi patches BEFORE build
      run: |
        echo "=== Подготовка патчей для libffi ==="
        
        # Создаем скрипт патча для libffi
        cat > /tmp/patch_libffi.sh << 'EOF'
#!/bin/bash
echo "Applying libffi patches for NDK 25b..."

# Находим директорию libffi
LIBFFI_DIR=$(find . -name "configure.ac" -type f | xargs grep -l "AC_TRY_RUN" | head -1 | xargs dirname 2>/dev/null)

if [ -z "$LIBFFI_DIR" ]; then
    echo "Libffi directory not found, will patch later"
    exit 0
fi

echo "Found libffi in: $LIBFFI_DIR"
cd "$LIBFFI_DIR"

# Создаем backup
cp configure.ac configure.ac.backup
cp aclocal.m4 aclocal.m4.backup 2>/dev/null || true

# Заменяем устаревшие макросы autoconf
echo "Patching configure.ac..."
sed -i 's/AC_TRY_RUN/AC_RUN_IFELSE/g' configure.ac
sed -i 's/AC_TRY_LINK/AC_LINK_IFELSE/g' configure.ac
sed -i 's/AC_TRY_COMPILE/AC_COMPILE_IFELSE/g' configure.ac
sed -i 's/AC_HELP_STRING/AS_HELP_STRING/g' configure.ac

# Добавляем недостающий макрос
if ! grep -q "LT_SYS_SYMBOL_USCORE" configure.ac; then
    echo "Adding LT_SYS_SYMBOL_USCORE macro..."
    sed -i '/AC_PROG_LD/a\LT_SYS_SYMBOL_USCORE' configure.ac
fi

# Также патчим aclocal.m4 если существует
if [ -f aclocal.m4 ]; then
    echo "Patching aclocal.m4..."
    sed -i 's/AC_TRY_RUN/AC_RUN_IFELSE/g' aclocal.m4
    sed -i 's/AC_TRY_LINK/AC_LINK_IFELSE/g' aclocal.m4
    sed -i 's/AC_TRY_COMPILE/AC_COMPILE_IFELSE/g' aclocal.m4
fi

echo "✅ Libffi patches applied"
EOF
        
        chmod +x /tmp/patch_libffi.sh
        
    - name: Create buildozer.spec with patches
      working-directory: ./artem_mobile_flet
      run: |
        echo "=== Создаем buildozer.spec с патчами ==="
        
        cat > buildozer.spec << 'EOF'
[app]
title = ARTEM Messenger
package.name = artem.messenger
package.domain = org.artem
source.dir = .
version = 1.0
requirements = python3,flet==0.21.2
orientation = portrait
android.api = 33
android.minapi = 21
android.ndk = 25b
android.accept_sdk_license = True

# Используем старый NDK чтобы избежать проблем с libffi
android.ndk = 23c
p4a.branch = master

# Указываем явно использовать SDL2 bootstrap
android.bootstrap = sdl2

[buildozer]
log_level = 2
EOF
        
        echo "=== buildozer.spec создан ==="
        cat buildozer.spec
        
    - name: Manual libffi patch during build
      working-directory: ./artem_mobile_flet
      run: |
        echo "=== Создаем скрипт для ручного патча libffi ==="
        
        # Создаем скрипт который будет запущен после загрузки libffi
        cat > .buildozer/patches/libffi_patch.sh << 'LIBFFI_PATCH_EOF'
#!/bin/bash
set -e

echo "=== Searching for libffi to patch ==="

# Ищем директории libffi
find . -type f -name "configure.ac" | while read configure_file; do
    if grep -q "AC_TRY_RUN\|AC_TRY_LINK\|LT_SYS_SYMBOL_USCORE" "$configure_file"; then
        echo "Patching libffi at: $(dirname "$configure_file")"
        cd "$(dirname "$configure_file")"
        
        # Backup
        cp configure.ac configure.ac.backup
        
        # Заменяем устаревшие макросы
        sed -i 's/AC_TRY_RUN/AC_RUN_IFELSE/g' configure.ac
        sed -i 's/AC_TRY_LINK/AC_LINK_IFELSE/g' configure.ac
        sed -i 's/AC_TRY_COMPILE/AC_COMPILE_IFELSE/g' configure.ac
        sed -i 's/AC_HELP_STRING/AS_HELP_STRING/g' configure.ac
        
        # Добавляем недостающий макрос
        if ! grep -q "LT_SYS_SYMBOL_USCORE" configure.ac; then
            echo "LT_SYS_SYMBOL_USCORE" >> configure.ac
        fi
        
        echo "✅ Patched: $configure_file"
        cd -
    fi
done

echo "=== Running autoreconf for patched files ==="
find . -name "configure.ac" -exec dirname {} \; | while read dir; do
    if [ -f "$dir/configure.ac.backup" ]; then
        echo "Running autoreconf in $dir"
        cd "$dir"
        autoreconf -fiv || true
        cd -
    fi
done

echo "✅ All libffi patches applied"
LIBFFI_PATCH_EOF
        
        chmod +x .buildozer/patches/libffi_patch.sh
        echo "Скрипт патча создан"
        
    - name: Build APK with manual intervention
      working-directory: ./artem_mobile_flet
      run: |
        echo "=== ЗАПУСК СБОРКИ С ПАТЧАМИ ==="
        echo "Эта сборка может занять 60-120 минут..."
        
        # Очищаем старые сборки
        rm -rf .buildozer bin 2>/dev/null || true
        
        # Создаем директории
        mkdir -p .buildozer/patches
        
        # Запускаем buildozer с ручным патчем
        echo "Step 1: Initializing build..."
        python3 -m buildozer android debug 2>&1 | tee build.log || true
        
        # Если была ошибка libffi, пробуем патчить и повторить
        if grep -q "AC_TRY_RUN\|AC_TRY_LINK\|LT_SYS_SYMBOL_USCORE" build.log; then
            echo "=== Обнаружена ошибка libffi, применяем патч ==="
            
            # Находим и патчим libffi
            find .buildozer -name "configure.ac" -type f | while read file; do
                if grep -q "AC_TRY_RUN\|AC_TRY_LINK" "$file"; then
                    echo "Patching: $file"
                    dir=$(dirname "$file")
                    cd "$dir"
                    
                    # Применяем патчи
                    sed -i 's/AC_TRY_RUN/AC_RUN_IFELSE/g' configure.ac
                    sed -i 's/AC_TRY_LINK/AC_LINK_IFELSE/g' configure.ac
                    sed -i 's/AC_TRY_COMPILE/AC_COMPILE_IFELSE/g' configure.ac
                    sed -i 's/AC_HELP_STRING/AS_HELP_STRING/g' configure.ac
                    
                    # Добавляем макрос если нужно
                    if ! grep -q "LT_SYS_SYMBOL_USCORE" configure.ac; then
                        echo "m4_ifdef([LT_SYS_SYMBOL_USCORE], [LT_SYS_SYMBOL_USCORE])" >> configure.ac
                    fi
                    
                    cd -
                fi
            done
            
            echo "=== Повторная попытка сборки после патча ==="
            python3 -m buildozer android debug 2>&1 | tee -a build.log
        fi
        
        # Проверяем результат
        if ls bin/*.apk 1> /dev/null 2>&1; then
            echo "✅✅✅ APK УСПЕШНО СОЗДАН! ✅✅✅"
            echo "Файлы APK:"
            ls -la bin/*.apk
            echo "Размер:"
            du -h bin/*.apk
        else
            echo "❌ APK не создан"
            echo "=== ПОСЛЕДНИЕ 100 СТРОК ЛОГА ==="
            tail -100 build.log
            echo "=== КРИТИЧЕСКИЕ ОШИБКИ ==="
            grep -i "error\|failed\|undefined" build.log | head -50
            exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ARTEM-Messenger-APK
        path: artem_mobile_flet/bin/*.apk
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: artem_mobile_flet/build.log
