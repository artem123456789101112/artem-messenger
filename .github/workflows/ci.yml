name: "Build ARTEM Messenger APK"
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip python3-dev openjdk-17-jdk cython3 git
          pip install buildozer cython flet==0.21.2
      
      - name: Create buildozer.spec
        working-directory: ./artem_mobile_flet
        run: |
          echo "[app]" > buildozer.spec
          echo "title = ARTEM Messenger" >> buildozer.spec
          echo "package.name = artem.messenger" >> buildozer.spec
          echo "package.domain = org.artem" >> buildozer.spec
          echo "source.dir = ." >> buildozer.spec
          echo "version = 1.0.0" >> buildozer.spec
          echo "requirements = python3,cython,flet==0.21.2" >> buildozer.spec
          echo "orientation = portrait" >> buildozer.spec
          echo "android.api = 33" >> buildozer.spec
          echo "android.minapi = 21" >> buildozer.spec
          echo "android.accept_sdk_license = true" >> buildozer.spec
          echo "android.ndk = 25b" >> buildozer.spec
          echo "" >> buildozer.spec
          echo "[buildozer]" >> buildozer.spec
          echo "log_level = 2" >> buildozer.spec
      
      - name: Build APK
        working-directory: ./artem_mobile_flet
        timeout-minutes: 150
        run: |
          echo "=== Starting build ==="
          buildozer android debug
          
          echo "=== Checking result ==="
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "✅ APK found!"
            ls -la bin/*.apk
          else
            echo "❌ No APK found"
          fi
      
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ARTEM-Messenger-APK
          path: artem_mobile_flet/bin/*.apk
