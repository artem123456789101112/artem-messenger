name: Build APK
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-22.04  # Используем стабильную версию
    timeout-minutes: 180
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: "3.10"  # Более стабильная версия
    - run: |
        sudo apt update
        sudo apt install -y python3-pip python3-dev openjdk-17-jdk git
        sudo apt install -y cython3 autoconf automake libtool pkg-config
        pip install buildozer cython flet
    - working-directory: ./artem_mobile_flet
      run: |
        # Создаем простой buildozer.spec
        echo "[app]" > buildozer.spec
        echo "title = ARTEM Messenger" >> buildozer.spec
        echo "package.name = artem.messenger" >> buildozer.spec
        echo "package.domain = org.artem" >> buildozer.spec
        echo "source.dir = ." >> buildozer.spec
        echo "version = 1.0" >> buildozer.spec
        echo "requirements = python3,flet" >> buildozer.spec  # Без cython
        echo "orientation = portrait" >> buildozer.spec
        echo "android.api = 33" >> buildozer.spec
        echo "android.minapi = 21" >> buildozer.spec
        echo "android.accept_sdk_license = true" >> buildozer.spec
        echo "android.ndk = 23c" >> buildozer.spec  # Стабильная версия
        echo "" >> buildozer.spec
        echo "[buildozer]" >> buildozer.spec
        echo "log_level = 2" >> buildozer.spec
    - working-directory: ./artem_mobile_flet
      run: |
        echo "Starting build... This will take 60-120 minutes"
        # Патч для libffi перед сборкой
        find . -name "configure.ac" -type f 2>/dev/null | head -5 | while read f; do
          echo "Patching $f"
          sed -i 's/AC_PROG_LD/AC_PROG_LD\nAC_PROG_LD_GNU/' "$f" 2>/dev/null || true
          sed -i 's/AC_TRY_RUN/AC_RUN_IFELSE/' "$f" 2>/dev/null || true
          sed -i 's/AC_TRY_LINK/AC_LINK_IFELSE/' "$f" 2>/dev/null || true
          sed -i 's/AC_TRY_COMPILE/AC_COMPILE_IFELSE/' "$f" 2>/dev/null || true
          sed -i 's/AC_HELP_STRING/AS_HELP_STRING/' "$f" 2>/dev/null || true
          echo "m4_ifdef([LT_SYS_SYMBOL_USCORE], [LT_SYS_SYMBOL_USCORE])" >> "$f"
        done
        buildozer android debug
    - uses: actions/upload-artifact@v4
      with:
        name: APK
        path: artem_mobile_flet/bin/*.apk
