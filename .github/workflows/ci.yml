name: "Build ARTEM Messenger APK"
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-dev \
          openjdk-17-jdk \
          cython3 \
          git \
          zip \
          unzip \
          libffi-dev \
          libssl-dev \
          autoconf \
          automake \
          libtool \
          pkg-config

    - name: Install Buildozer and Flet
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer
        pip install cython
        pip install flet==0.21.2

    - name: Create optimized buildozer.spec
      working-directory: ./artem_mobile_flet
      run: |
        echo "Creating optimized buildozer.spec..."
        
        # Удаляем старый файл
        rm -f buildozer.spec
        
        # Создаем новый с правильными настройками
        echo "[app]" > buildozer.spec
        echo "title = ARTEM Messenger" >> buildozer.spec
        echo "package.name = artem.messenger" >> buildozer.spec
        echo "package.domain = org.artem" >> buildozer.spec
        echo "source.dir = ." >> buildozer.spec
        echo "version = 1.0.0" >> buildozer.spec
        echo "requirements = python3,kivy==2.3.0,cython,flet==0.21.2" >> buildozer.spec
        echo "orientation = portrait" >> buildozer.spec
        echo "fullscreen = 0" >> buildozer.spec
        echo "android.api = 33" >> buildozer.spec
        echo "android.minapi = 21" >> buildozer.spec
        echo "android.accept_sdk_license = true" >> buildozer.spec
        echo "android.ndk = 25b" >> buildozer.spec
        echo "android.sdk = 33" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "# Исправление проблем с libffi" >> buildozer.spec
        echo "[buildozer]" >> buildozer.spec
        echo "log_level = 2" >> buildozer.spec
        echo "warn_on_root = 1" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "# Переопределение рецептов для исправления libffi" >> buildozer.spec
        echo "[app:source.exclude_patterns]" >> buildozer.spec
        echo "*.pyc" >> buildozer.spec
        echo "__pycache__" >> buildozer.spec
        echo ".buildozer" >> buildozer.spec
        
        echo "✅ buildozer.spec created"
        cat buildozer.spec

    - name: Create libffi patch file
      working-directory: ./artem_mobile_flet
      run: |
        echo "Creating libffi patch for NDK 25b..."
        
        # Создаем патч-файл для libffi
        cat > patch_libffi.sh << 'EOF'
#!/bin/bash
echo "=== Applying libffi patches for NDK 25b ==="

# Ищем директорию libffi в .buildozer
find .buildozer -name "configure.ac" -type f | while read file; do
    echo "Patching $file"
    # Исправляем устаревшие макросы autoconf
    sed -i 's/AC_PROG_LD/AC_PROG_LD\nAC_PROG_LD_GNU/' "$file"
    sed -i 's/AC_TRY_RUN/AC_RUN_IFELSE/' "$file"
    sed -i 's/AC_TRY_LINK/AC_LINK_IFELSE/' "$file"
    sed -i 's/AC_TRY_COMPILE/AC_COMPILE_IFELSE/' "$file"
    sed -i 's/AC_HELP_STRING/AS_HELP_STRING/' "$file"
    
    # Добавляем недостающий макрос
    if ! grep -q "LT_SYS_SYMBOL_USCORE" "$file"; then
        echo "m4_ifdef([LT_SYS_SYMBOL_USCORE], [LT_SYS_SYMBOL_USCORE])" >> "$file"
    fi
done

# Также патчим aclocal.m4
find .buildozer -name "aclocal.m4" -type f | while read file; do
    echo "Patching $file"
    sed -i 's/AC_PROG_LD/AC_PROG_LD\nAC_PROG_LD_GNU/' "$file"
done

echo "✅ libffi patches applied"
EOF
        
        chmod +x patch_libffi.sh

    - name: Build APK with patches
      working-directory: ./artem_mobile_flet
      timeout-minutes: 150
      run: |
        echo "=== STARTING FINAL APK BUILD ==="
        echo "This will take 60-120 minutes..."
        
        # Сначала инициализируем buildozer
        echo "Step 1: Initializing Buildozer..."
        buildozer init 2>&1 | tail -30
        
        # Применяем патчи к libffi
        echo "Step 2: Applying libffi patches..."
        if [ -f "patch_libffi.sh" ]; then
            ./patch_libffi.sh 2>&1 | tail -20
        fi
        
        # Запускаем сборку с подробным выводом
        echo "Step 3: Building APK..."
        echo "=== FULL BUILD LOG START ==="
        
        # Сохраняем логи в файл и выводим в реальном времени
        buildozer -v android debug 2>&1 | tee full_build.log
        
        # Проверяем результат
        echo "=== BUILD RESULT ==="
        if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "🎉 🎉 🎉 SUCCESS! APK FOUND! 🎉 🎉 🎉"
            echo "APK files:"
            ls -la bin/*.apk
            echo "APK size: $(du -h bin/*.apk | cut -f1)"
            
            # Копируем для надежности
            mkdir -p dist/
            cp bin/*.apk dist/
            echo "Copied to dist/ folder"
            
        else
            echo "❌ No APK in bin/, searching..."
            find . -name "*.apk" -type f 2>/dev/null | while read file; do
                echo "Found: $file"
                ls -la "$file"
                # Копируем в bin/
                mkdir -p bin
                cp "$file" bin/
            done
            
            if ! find . -name "*.apk" -type f 2>/dev/null | grep -q .; then
                echo "❌❌❌ NO APK FOUND ANYWHERE!"
                echo "Last 50 lines of build log:"
                tail -50 full_build.log
                echo "Looking for error logs..."
                find . -name "*.log" -type f | head -3 | xargs -I {} sh -c 'echo "=== {} ==="; tail -30 {}'
                exit 1
            fi
        fi

    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ARTEM-Messenger-APK
        path: artem_mobile_flet/bin/*.apk
        retention-days: 7

    - name: Upload all APKs
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: All-APKs
        path: |
          artem_mobile_flet/bin/*.apk
          artem_mobile_flet/dist/*.apk
        if-no-files-found: ignore
        retention-days: 7

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: |
          artem_mobile_flet/full_build.log
          artem_mobile_flet/.buildozer/**/*.log
        if-no-files-found: ignore
        retention-days: 3
